@startuml
actor Farmacista as F
entity UI
control Controller as C
participant WebSocket as W
entity LocalStorage as WL
participant ChaCha20 as CC
F->UI:Invia richiesta apertura Chat
UI->C:Invia la richiesta
C->W:Stabilisci la connessione
par
loop Connection are active
opt Messagio in arrivo

W->C:Ricevi Messagio
C->CC:Decifra il messaggio
CC-->C:Restituisce messaggio decrifrato
C->WL:Archivia il messaggio
end opt
end loop
end par

par
loop Connection are active
opt Farmacista vuole scrivere un messaggio
F->UI:Scrivi Messagio
UI->C:Send request
C->CC:Cifra il messaggio
CC-->C:Restituisce messaggio cifrato
C->W:Invia Messagio Cifrato
C->WL:Inserisco messaggio in coda
end opt
end loop
end par
par
alt Addetto interrompe Chat
F->UI:Chiudi Chat
UI->C:Invia Messagio di Chiusura
C->W:Chiudi la connessione
W-->C:Connessione Terminata
else Venditore Chiude Chat
W->C:Notifica Conessione chiusa
C->UI:Mostra connessione chiusa
end if
end par



@enduml